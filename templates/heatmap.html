<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Türkiye Tanı Isı Haritası</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      display: none;
      pointer-events: none;
      z-index: 10;
      white-space: pre-line;
    }
    svg { width: 100%; height: auto; max-width: 1000px; margin: auto; display: block; }
    path {
      stroke: #999; stroke-width: 0.5;
      transition: fill 0.3s;
    }
    path:hover {
      stroke: #ff6600; stroke-width: 1;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>Türkiye Tanı Isı Haritası</h2>
<div class="tooltip" id="tooltip"></div>
<div id="map-container">Harita yükleniyor...</div>

<script>
  const tooltip = document.getElementById('tooltip');

  function getColor(intensity) {
    const r = Math.floor(255 * intensity);
    const g = 255 - r;
    return `rgb(${r},${g},80)`;
  }

  Promise.all([
    fetch(`/static/turkiye.svg?v=${Date.now()}`).then(r => r.text()),
    fetch(`/static/harita-veri.json?v=${Date.now()}`).then(r => r.json()),
    fetch(`/static/iller.json?v=${Date.now()}`).then(r => r.json())
  ])
  .then(([svgText, data, sehirKodlari]) => {
    // Eğer data bir dizi ise şehirlere göre grupla
    if (Array.isArray(data)) {
      const grouped = {};
      data.forEach(entry => {
        const { sehir, tani, kisi_sayisi } = entry;
        if (!grouped[sehir]) {
          grouped[sehir] = [];
        }
        grouped[sehir].push({ tani, kisi: kisi_sayisi });
      });
      data = grouped;
    }

    document.getElementById('map-container').innerHTML = svgText;

    const maxValue = Math.max(...Object.values(data).map(info => {
      if (Array.isArray(info)) {
        return info.reduce((sum, item) => sum + item.kisi, 0);
      } else {
        return info.kisi;
      }
    }));

    Object.entries(data).forEach(([sehirAdi, info]) => {
      // Şehir kodunu al
      const sehirId = sehirKodlari[sehirAdi];
      if (!sehirId) {
        console.warn(`"${sehirAdi}" için şehir kodu bulunamadı.`);
        return;
      }

      const path = document.getElementById(sehirId);
      if (!path) {
        console.warn(`"${sehirId}" id'sine sahip şehir SVG'de bulunamadı.`);
        return;
      }

      let kisiToplam = 0;
      let tooltipText = sehirAdi + '\n';

      if (Array.isArray(info)) {
        kisiToplam = info.reduce((sum, item) => sum + item.kisi, 0);
        info.forEach(item => {
          tooltipText += `${item.tani}: ${item.kisi}\n`;
        });
      } else {
        kisiToplam = info.kisi;
        tooltipText += `${info.tani}: ${info.kisi}`;
      }

      const oran = kisiToplam / maxValue;
      path.style.fill = getColor(oran);

      path.addEventListener('mousemove', e => {
        tooltip.textContent = tooltipText;
        tooltip.style.left = (e.pageX + 15) + 'px';
        tooltip.style.top = (e.pageY + 15) + 'px';
        tooltip.style.display = 'block';
      });

      path.addEventListener('mouseleave', () => {
        tooltip.style.display = 'none';
      });
    });
  })
  .catch(err => {
    console.error("Harita veya veri yüklenemedi:", err);
    document.getElementById('map-container').innerHTML = "<p style='color:red;'>Harita veya veri yüklenemedi.</p>";
  });
</script>

</body>
</html>
